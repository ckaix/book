<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <!--<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>-->
    <title>40-软件部署实战（上）：部署方案及负载均衡、高可用组件介绍</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <style>
        html {
            color: #333;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-rendering: optimizelegibility;
            font-family: Helvetica Neue, PingFang SC, Verdana, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, sans-serif
        }

        html.borderbox *,
        html.borderbox :after,
        html.borderbox :before {
            box-sizing: border-box
        }

        article,
        aside,
        blockquote,
        body,
        button,
        code,
        dd,
        details,
        dl,
        dt,
        fieldset,
        figcaption,
        figure,
        footer,
        form,
        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        header,
        hr,
        input,
        legend,
        li,
        menu,
        nav,
        ol,
        p,
        pre,
        section,
        td,
        textarea,
        th,
        ul {
            margin: 0;
            padding: 0
        }

        article,
        aside,
        details,
        figcaption,
        figure,
        footer,
        header,
        menu,
        nav,
        section {
            display: block
        }

        audio,
        canvas,
        video {
            display: inline-block
        }

        body,
        button,
        input,
        select,
        textarea {
            font: 300 1em/1.8 PingFang SC, Lantinghei SC, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, Helvetica, sans-serif
        }

        button::-moz-focus-inner,
        input::-moz-focus-inner {
            padding: 0;
            border: 0
        }

        table {
            border-collapse: collapse;
            border-spacing: 0
        }

        fieldset,
        img {
            border: 0
        }

        blockquote {
            position: relative;
            color: #999;
            font-weight: 400;
            border-left: 1px solid #1abc9c;
            padding-left: 1em;
            margin: 1em 3em 1em 2em
        }

        @media only screen and (max-width: 640px) {
            blockquote {
                margin: 1em 0
            }
        }

        abbr,
        acronym {
            border-bottom: 1px dotted;
            font-variant: normal
        }

        abbr {
            cursor: help
        }

        del {
            text-decoration: line-through
        }

        address,
        caption,
        cite,
        code,
        dfn,
        em,
        th,
        var {
            font-style: normal;
            font-weight: 400
        }

        ol,
        ul {
            list-style: none
        }

        caption,
        th {
            text-align: left
        }

        q:after,
        q:before {
            content: ""
        }

        sub,
        sup {
            font-size: 75%;
            line-height: 0;
            position: relative
        }

        :root sub,
        :root sup {
            vertical-align: baseline
        }

        sup {
            top: -.5em
        }

        sub {
            bottom: -.25em
        }

        a {
            color: #1abc9c
        }

        a:hover {
            text-decoration: underline
        }

        .typo a {
            border-bottom: 1px solid #1abc9c
        }

        .typo a:hover {
            border-bottom-color: #555;
            color: #555
        }

        .typo a:hover,
        a,
        ins {
            text-decoration: none
        }

        .typo-u,
        u {
            text-decoration: underline
        }

        mark {
            background: #fffdd1;
            border-bottom: 1px solid #ffedce;
            padding: 2px;
            margin: 0 5px
        }

        code,
        pre,
        pre tt {
            font-family: Courier, Courier New, monospace
        }

        pre {
            background: hsla(0, 0%, 97%, .7);
            border: 1px solid #ddd;
            padding: 1em 1.5em;
            display: block;
            -webkit-overflow-scrolling: touch
        }

        hr {
            border: none;
            border-bottom: 1px solid #cfcfcf;
            margin-bottom: .8em;
            height: 10px
        }

        .typo-small,
        figcaption,
        small {
            font-size: .9em;
            color: #888
        }

        b,
        strong {
            font-weight: 700;
            color: #000
        }

        [draggable] {
            cursor: move
        }

        .clearfix:after,
        .clearfix:before {
            content: "";
            display: table
        }

        .clearfix:after {
            clear: both
        }

        .clearfix {
            zoom: 1
        }

        .textwrap,
        .textwrap td,
        .textwrap th {
            word-wrap: break-word;
            word-break: break-all
        }

        .textwrap-table {
            table-layout: fixed
        }

        .serif {
            font-family: Palatino, Optima, Georgia, serif
        }

        .typo-dl,
        .typo-form,
        .typo-hr,
        .typo-ol,
        .typo-p,
        .typo-pre,
        .typo-table,
        .typo-ul,
        .typo dl,
        .typo form,
        .typo hr,
        .typo ol,
        .typo p,
        .typo pre,
        .typo table,
        .typo ul,
        blockquote {
            margin-bottom: 1rem
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: PingFang SC, Helvetica Neue, Verdana, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, sans-serif;
            color: #000;
            line-height: 1.35
        }

        .typo-h1,
        .typo-h2,
        .typo-h3,
        .typo-h4,
        .typo-h5,
        .typo-h6,
        .typo h1,
        .typo h2,
        .typo h3,
        .typo h4,
        .typo h5,
        .typo h6 {
            margin-top: 1.2em;
            margin-bottom: .6em;
            line-height: 1.35
        }

        .typo-h1,
        .typo h1 {
            font-size: 2em
        }

        .typo-h2,
        .typo h2 {
            font-size: 1.8em
        }

        .typo-h3,
        .typo h3 {
            font-size: 1.6em
        }

        .typo-h4,
        .typo h4 {
            font-size: 1.4em
        }

        .typo-h5,
        .typo-h6,
        .typo h5,
        .typo h6 {
            font-size: 1.2em
        }

        .typo-ul,
        .typo ul {
            margin-left: 1.3em;
            list-style: disc
        }

        .typo-ol,
        .typo ol {
            list-style: decimal;
            margin-left: 1.9em
        }

        .typo-ol ol,
        .typo-ol ul,
        .typo-ul ol,
        .typo-ul ul,
        .typo li ol,
        .typo li ul {
            margin-bottom: .8em;
            margin-left: 2em
        }

        .typo-ol ul,
        .typo-ul ul,
        .typo li ul {
            list-style: circle
        }

        .typo-table td,
        .typo-table th,
        .typo table caption,
        .typo table td,
        .typo table th {
            border: 1px solid #ddd;
            padding: .5em 1em;
            color: #666
        }

        .typo-table th,
        .typo table th {
            background: #fbfbfb
        }

        .typo-table thead th,
        .typo table thead th {
            background: hsla(0, 0%, 95%, .7)
        }

        .typo table caption {
            border-bottom: none
        }

        .typo-input,
        .typo-textarea {
            -webkit-appearance: none;
            border-radius: 0
        }

        .typo-em,
        .typo em,
        caption,
        legend {
            color: #000;
            font-weight: inherit
        }

        .typo-em {
            position: relative
        }

        .typo-em:after {
            position: absolute;
            top: .65em;
            left: 0;
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
            content: "\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB"
        }

        .typo img {
            max-width: 100%
        }

        .common-content {
            font-weight: 400;
            color: #353535;
            line-height: 1.75rem;
            white-space: normal;
            word-break: normal;
            font-size: 1rem
        }

        .common-content img {
            display: block;
            max-width: 100%;
            background-color: #eee
        }

        .common-content audio,
        .common-content video {
            width: 100%;
            background-color: #eee
        }

        .common-content center,
        .common-content font {
            margin-top: 1rem;
            display: inline-block
        }

        .common-content center {
            width: 100%
        }

        .common-content pre {
            margin-top: 1rem;
            padding-left: 0;
            padding-right: 0;
            position: relative;
            overflow: hidden
        }

        .common-content pre code {
            font-size: .8rem;
            font-family: Consolas, Liberation Mono, Menlo, monospace, Courier;
            display: block;
            width: 100%;
            box-sizing: border-box;
            padding-left: 1rem;
            padding-right: 1rem;
            overflow-x: auto
        }

        .common-content hr {
            border: none;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            border-top: 1px solid #f5f5f5;
            height: 1px;
            background: none
        }

        .common-content b,
        .common-content h1,
        .common-content h2,
        .common-content h3,
        .common-content h4,
        .common-content h5,
        .common-content strong {
            font-weight: 700
        }

        .common-content h1,
        .common-content h2 {
            font-size: 1.125rem;
            margin-bottom: .45rem
        }

        .common-content h3,
        .common-content h4,
        .common-content h5 {
            font-size: 1rem;
            margin-bottom: .45rem
        }

        .common-content p {
            font-weight: 400;
            color: #353535;
            margin-top: .15rem
        }

        .common-content .orange {
            color: #ff5a05
        }

        .common-content .reference {
            font-size: 1rem;
            color: #888
        }

        .custom-rich-content h1 {
            margin-top: 0;
            font-weight: 400;
            font-size: 15.25px;
            border-bottom: 1px solid #eee;
            line-height: 2.8
        }

        .custom-rich-content li,
        .custom-rich-content p {
            font-size: 14px;
            color: #888;
            line-height: 1.6
        }

        table.hljs-ln {
            margin-bottom: 0;
            border-spacing: 0;
            border-collapse: collapse
        }

        table.hljs-ln,
        table.hljs-ln tbody,
        table.hljs-ln td,
        table.hljs-ln tr {
            box-sizing: border-box
        }

        table.hljs-ln td {
            padding: 0;
            border: 0
        }

        table.hljs-ln td.hljs-ln-numbers {
            min-width: 15px;
            color: rgba(27, 31, 35, .3);
            text-align: right;
            white-space: nowrap;
            cursor: pointer;
            user-select: none
        }

        table.hljs-ln td.hljs-ln-code,
        table.hljs-ln td.hljs-ln-numbers {
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, Courier, monospace;
            font-size: 12px;
            line-height: 20px;
            vertical-align: top
        }

        table.hljs-ln td.hljs-ln-code {
            position: relative;
            padding-right: 10px;
            padding-left: 10px;
            overflow: visible;
            color: #24292e;
            word-wrap: normal;
            white-space: pre
        }

        video::-webkit-media-controls {
            overflow: hidden !important
        }

        video::-webkit-media-controls-enclosure {
            width: calc(100% + 32px);
            margin-left: auto
        }

        ._29HP61GA_0 {
            max-width:800px;
            margin:0 auto;
            margin-bottom: 20px;
            font-weight: 400;
            color: #353535;
            line-height: 1.76;
            white-space: normal;
            word-break: normal;
            font-size: 17px;
            -webkit-transition: background-color .3s ease;
            transition: background-color .3s ease
        }

        ._29HP61GA_0 .MathJax_Display {
            overflow: auto
        }

        ._29HP61GA_0 .poster {
            position: fixed;
            left: -10000px;
            top: -10000px;
            overflow: hidden;
            padding: 1rem;
            background: #ececec
        }

        ._29HP61GA_0 .richcontent-pre-copy {
            font-size: 13px;
            color: #888;
            position: absolute;
            right: 1em;
            top: .5em;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none
        }

        ._29HP61GA_0 .richcontent-pre-copy .iconfont {
            font-size: 12px;
            margin-right: .2em
        }

        ._29HP61GA_0 a {
            color: #fa8919;
            border-bottom: 1px solid #fa8919
        }

        ._29HP61GA_0 img {
            display: block;
            max-width: 100%;
            position: relative;
            left: 50%;
            -webkit-transform: translateX(-50%);
            transform: translateX(-50%);
            background-color: #eee;
            vertical-align: top;
            border-radius: 0
        }

        ._29HP61GA_0 audio,
        ._29HP61GA_0 video {
            width: 100%;
            background-color: #eee
        }

        ._29HP61GA_0 pre {
            margin-top: 16px;
            padding: 34px 0 0;
            margin-bottom: 30px;
            position: relative;
            border-radius: 6px;
            background: rgba(246, 247, 251, .749);
            border: 0
        }

        ._29HP61GA_0 pre code {
            font-size: 12px;
            font-family: Consolas, Liberation Mono, Menlo, monospace, Courier;
            display: block;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
            margin-left: 16px;
            margin-right: 16px;
            overflow-x: scroll
        }

        ._29HP61GA_0 pre code:after {
            content: "";
            height: 30px;
            width: 100%;
            display: block
        }

        ._29HP61GA_0 hr {
            border: none;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            border-top: 1px solid #f5f5f5;
            height: 1px;
            background: none
        }

        ._29HP61GA_0 h1,
        ._29HP61GA_0 h2,
        ._29HP61GA_0 h3,
        ._29HP61GA_0 h4,
        ._29HP61GA_0 h5 {
            margin-bottom: 20px;
            margin-top: 0;
            font-weight: 700
        }

        ._29HP61GA_0 b,
        ._29HP61GA_0 strong {
            font-weight: 700
        }

        ._29HP61GA_0 h1 {
            font-size: 21px
        }

        ._29HP61GA_0 h2 {
            font-size: 20px
        }

        ._29HP61GA_0 h3 {
            font-size: 19px
        }

        ._29HP61GA_0 h4 {
            font-size: 18px
        }

        ._29HP61GA_0 h5 {
            font-size: 17px
        }

        ._29HP61GA_0 center,
        ._29HP61GA_0 p {
            font-weight: 400;
            color: #353535;
            margin-top: 0;
            margin-bottom: 30px;
            word-break: break-word
        }

        ._29HP61GA_0 center {
            text-align: center
        }

        ._29HP61GA_0 blockquote {
            margin-top: 0;
            margin-bottom: 34px;
            border-left: 3px solid #e8e8e8;
            padding-left: 17px;
            color: #353535
        }

        ._29HP61GA_0 blockquote p {
            margin-top: 0;
            margin-bottom: 0
        }

        ._29HP61GA_0 ol,
        ._29HP61GA_0 ul {
            margin-bottom: 30px
        }

        ._29HP61GA_0 ol p,
        ._29HP61GA_0 ul p {
            margin-top: 0;
            margin-bottom: 0
        }

        ._29HP61GA_0 ol {
            list-style: decimal;
            margin-left: 20px
        }

        ._29HP61GA_0 ul li {
            padding-left: 17px;
            position: relative;
            margin-bottom: 10px
        }

        ._29HP61GA_0 ul li:after {
            content: "";
            height: 6px;
            width: 6px;
            border-radius: 50%;
            background: #353535;
            position: absolute;
            top: 10px;
            left: 0
        }

        ._29HP61GA_0 .orange {
            color: #fa8919
        }

        ._29HP61GA_0 .reference {
            color: #888
        }

        ._29HP61GA_0 .m-right {
            text-align: right
        }

        ._29HP61GA_0 .m-center {
            text-align: center;
            display: block
        }

        ._29HP61GA_0 .m-gray {
            color: #888
        }

        ._29HP61GA_0 .m-small {
            font-size: 15px
        }

        ._29HP61GA_0 table.hljs-ln {
            margin-bottom: 0;
            border-spacing: 0;
            border-collapse: collapse
        }

        ._29HP61GA_0 table.hljs-ln,
        ._29HP61GA_0 table.hljs-ln tbody,
        ._29HP61GA_0 table.hljs-ln td,
        ._29HP61GA_0 table.hljs-ln tr {
            -webkit-box-sizing: border-box;
            box-sizing: border-box
        }

        ._29HP61GA_0 table.hljs-ln td {
            padding: 0;
            border: 0
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-numbers {
            min-width: 15px;
            font-size: 12px;
            color: rgba(27, 31, 35, .3);
            text-align: right;
            white-space: nowrap;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-code,
        ._29HP61GA_0 table.hljs-ln td.hljs-ln-numbers {
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, Courier, monospace;
            line-height: 20px;
            vertical-align: top
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-code {
            position: relative;
            padding-right: 10px;
            padding-left: 10px;
            overflow: visible;
            font-size: 13px;
            color: #666;
            word-wrap: normal;
            white-space: pre
        }

    </style>
</head>
<body>
<div class="_29HP61GA_0">
<h1>40-软件部署实战（上）：部署方案及负载均衡、高可用组件介绍</h1>
<p>你好，我是孔令飞。</p><p>接下来，我们就进入到这门课的最后一个模块，服务部署部分的学习。在这一模块中，我会带着你一步一步地部署一个生产级可用的IAM应用。</p><p>在 <a href="https://time.geekbang.org/column/article/378082">03讲</a> 中，我们快速在单机上部署了IAM系统，但这样的系统缺少高可用、弹性扩容等能力，是很脆弱的，遇到流量波峰、发布变更很容易出问题。在系统真正上线前，我们需要重新调整部署架构，来保证我们的系统具有负载均衡、高可用、弹性伸缩等核心运维能力。</p><p>考虑到你手中的系统资源有限，这一模块会尽量简单地展示如何部署一个相对高可用的IAM系统。按照我讲的部署方法，基本上可以上线一个中小型的系统。</p><p>在这一模块中，我会介绍两种部署方式。</p><p>第一种是传统的部署方式，基于物理机/虚拟机来部署，容灾、弹性伸缩能力要部署人员自己实现。第二种是容器化部署方式，基于Docker、Kubernetes来部署，容灾、弹性伸缩等能力，可以借助Kubernetes自带的能力来实现。</p><p>接下来的三讲，我们先来看下传统的部署方式，也就是如何基于虚拟机来部署IAM应用。今天我主要讲跟IAM部署相关的两个组件，Nginx + Keepalived的相关功能。</p><h2>部署方案</h2><p>先来整体看下我们的部署方案。</p><p>这里，我采用Nginx + Keepalived来部署一个高可用的架构，同时将组件都部署在内网，来保证服务的安全和性能。</p><!-- [[[read_end]]] --><p>部署需要两台物理机/虚拟机，组件之间通过内网访问。所需的服务器如下表所示：</p><p><img src="https://static001.geekbang.org/resource/image/e0/1d/e0a3323831768fbe7f45085ca4a53a1d.jpg?wh=1920x719" alt="图片"></p><p>两台服务器均为腾讯云CVM，VIP（Virtual IP，虚拟IP）为<code>10.0.4.99</code>。部署架构如下图所示：</p><p><img src="https://static001.geekbang.org/resource/image/fc/9d/fc5331a780d45a7de6223d6ff3c86f9d.jpg?wh=1920x1197" alt="图片"></p><p>这里我来具体介绍下图中的部署架构。部署采用的这两台CVM服务器，一主一备，它们共享同一个VIP。同一时刻，VIP只在一台主设备上生效，当主服务器出现故障时，备用服务器会自动接管VIP，继续提供服务。</p><p>主服务器上部署了<code>iam-apiserver</code>、<code>iam-authz-server</code>、<code>iam-pump</code>和数据库<code>mongodb</code>、<code>redis</code>、<code>mysql</code>。备服务器部署了<code>iam-apiserver</code>、<code>iam-authz-server</code>和<code>iam-pump</code>。备服务器中的组件通过内网<code>10.0.4.20</code>访问主服务器中的数据库组件。</p><p>主备服务器同时安装了Keepalived和Nginx，通过Nginx的反向代理功能和负载均衡功能，实现后端服务<code>iam-apiserver</code>和<code>iam-authz-server</code>的高可用，通过Keepalived实现Nginx的高可用。</p><p>我们通过给虚拟IP绑定腾讯云弹性公网IP，从而使客户端可以通过外网IP访问内网的Nginx服务器（<code>443</code>端口），如果想通过域名访问内网，还可以申请域名指向该弹性公网IP。</p><p>通过以上部署方案，我们可以实现一个具有较高可用性的IAM系统，它主要具备下面这几个能力。</p><ul>
<li>高性能：可以通过Nginx的负载均衡功能，水平扩容IAM服务，从而实现高性能。</li>
<li>具备容灾能力：通过Nginx实现IAM服务的高可用，通过Keepalived实现Nginx的高可用，从而实现核心组件的高可用。</li>
<li>具备水平扩容能力：通过Nginx的负载均衡功能，实现IAM服务的水平扩容。</li>
<li>高安全性：将所有组件部署在内网，客户端只能通过<code>VIP:443</code>端口访问Nginx服务，并且通过开启TLS认证和JWT认证，保障服务有一个比较高的安全性。因为是腾讯云CVM，所以也可以借助腾讯云的能力再次提高服务器的安全性，比如安全组、DDoS防护、主机安全防护、云监控、云防火墙等。</li>
</ul><p>这里说明下，为了简化IAM应用的安装配置过程，方便你上手实操，有些能力，例如数据库高可用、进程监控和告警、自动伸缩等能力的构建方式，这里没有涉及到。这些能力的构建方式，你可以在日后的工作中慢慢学习和掌握。</p><p>接下来，我们看下这个部署方案中用到的两个核心组件，Nginx和Keepalived。我会介绍下它们的安装和配置方法，为你下一讲的学习做准备。</p><h2>Nginx安装和配置</h2><h3>Nginx功能简介</h3><p>这里先简单介绍下Nginx。Nginx是一个轻量级、高性能、开源的HTTP服务器和反向代理服务器。IAM系统使用了Nginx反向代理和负载均衡的功能，下面我就来分别介绍下。</p><p>为什么需要反向代理呢？在实际的生产环境中，服务部署的网络（内网）跟外部网络（外网）通常是不通的，这就需要一台既能够访问内网又能够访问外网的服务器来做中转，这种服务器就是反向代理服务器。Nginx作为反向代理服务器，简单的配置如下：</p><pre><code class="language-plain">server {
&nbsp; &nbsp; listen&nbsp; &nbsp; &nbsp; 80;
&nbsp; &nbsp; server_name&nbsp; iam.marmotedu.com;
&nbsp; &nbsp; client_max_body_size 1024M;

&nbsp; &nbsp; location / {
&nbsp; &nbsp; &nbsp; &nbsp; proxy_set_header Host $http_host;
&nbsp; &nbsp; &nbsp; &nbsp; proxy_set_header X-Forwarded-Host $http_host;
&nbsp; &nbsp; &nbsp; &nbsp; proxy_set_header X-Real-IP $remote_addr;
&nbsp; &nbsp; &nbsp; &nbsp; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
&nbsp; &nbsp; &nbsp; &nbsp; proxy_pass&nbsp; http://127.0.0.1:8080/;
&nbsp; &nbsp; &nbsp; &nbsp; client_max_body_size 100m;
&nbsp; &nbsp; }
}
</code></pre><p>Nginx的反向代理功能，能够根据不同的配置规则转发到不同的后端服务器上。假如我们在IP为<code>x.x.x.x</code>的服务器上，用上面说的Nginx配置启动Nginx，当我们访问<code>http://x.x.x.x:80/</code>时，会将请求转发到<code>http://127.0.0.1:8080/</code>。<code>listen      80</code>指定了Nginx服务器的监听端口，<code>proxy_pass  http://127.0.0.1:8080/</code>则指定了转发路径。</p><p>Nginx另一个常用的功能是七层负载均衡。所谓的负载均衡，就是指当Nginx收到一个HTTP请求后，会根据负载策略将请求转发到不同的后端服务器上。比如iam-apiserver部署在两台服务器A和B上，当请求到达Nginx后，Nginx会根据A和B服务器上的负载情况，将请求转发到负载较小的那台服务器上。</p><p>这里要求iam-apiserver是无状态的服务。Nginx有多种负载均衡策略，可以满足不同场景下的负载均衡需求。</p><h3><strong>Nginx安装步骤</strong></h3><p>接下来，我就来介绍下如何安装和配置Nginx。</p><p>我们分别在<code>10.0.4.20</code>和<code>10.0.4.21</code>服务器上执行如下步骤，安装Nginx。</p><p>在CentOS 8.x系统上，我们可以使用yum命令来安装，具体安装过程可以分为下面4个步骤。</p><p>第一步，安装Nginx：</p><pre><code class="language-bash">$ sudo yum -y install nginx
</code></pre><p>第二步，确认Nginx安装成功：</p><pre><code class="language-bash">$ nginx -v
nginx version: nginx/1.14.1
</code></pre><p>第三步，启动Nginx，并设置开机启动：</p><pre><code class="language-bash">$ sudo systemctl start nginx
$ sudo systemctl enable nginx
</code></pre><p>Nginx默认监听<code>80</code>端口，启动Nginx前要确保<code>80</code>端口没有被占用。当然，你也可以通过修改Nginx配置文件<code>/etc/nginx/nginx.conf</code>修改Nginx监听端口。</p><p>第四步，查看Nginx启动状态：</p><pre><code class="language-bash">$ systemctl status nginx
</code></pre><p>输出中有<code>active (running)</code>字符串，说明成功启动。如果Nginx启动失败，你可以查看<code>/var/log/nginx/error.log</code>日志文件，定位错误原因。</p><h2>Keepalived安装和配置</h2><p>Nginx自带负载均衡功能，并且当Nginx后端某个服务器故障后，Nginx会自动剔除该服务器，将请求转发到可用的服务器，通过这种方式实现后端API服务的高可用。但是 Nginx是单点的，如果Nginx挂了，后端的所有服务器就都不能访问，所以在实际生产环境中，也需要对Nginx做高可用。</p><p>业界最普遍采用的方法是通过Keepalived对前端Nginx实现高可用。Keepalived + Nginx的高可用方案具有服务功能强大、维护简单等特点。</p><p>接下来，我们来看下如何安装和配置Keepalived。</p><h3>Keepalived安装步骤</h3><p>我们分别在<code>10.0.4.20</code>和<code>10.0.4.21</code>服务器上执行下面5个步骤，安装Keepalived。</p><p>第一步，下载Keepalived的最新版本（这门课安装了当前的最新版本 <code>2.1.5</code>）：</p><pre><code class="language-bash">$ wget https://www.keepalived.org/software/keepalived-2.1.5.tar.gz
</code></pre><p>第二步，安装Keepalived：</p><pre><code class="language-bash">$ sudo yum -y install openssl-devel # keepalived依赖OpenSSL，先安装依赖
$ tar -xvzf keepalived-2.1.5.tar.gz
$ cd keepalived-2.1.5
$ ./configure --prefix=/usr/local/keepalived
$ make
$ sudo make install
</code></pre><p>第三步，配置Keepalived：</p><pre><code class="language-bash">$ sudo mkdir /etc/keepalived # 安装后，默认没有创建/etc/keepalived目录
$ sudo cp /usr/local/keepalived/etc/keepalived/keepalived.conf  /etc/keepalived/keepalived.conf
$ sudo cp /usr/local/keepalived/etc/sysconfig/keepalived /etc/sysconfig/keepalived
</code></pre><p>Keepalived的systemd uint配置，默认使用了<code>/usr/local/keepalived/etc/sysconfig/keepalived</code>作为其<code>EnvironmentFile</code>，我们还需要把它修改为<code>/etc/sysconfig/keepalived</code>文件。编辑<code>/lib/systemd/system/keepalived.service</code>文件，设置<code>EnvironmentFile</code>，值如下：</p><pre><code class="language-bash">EnvironmentFile=-/etc/sysconfig/keepalived
</code></pre><p>第四步，启动Keepalived，并设置开机启动：</p><pre><code class="language-bash">$ sudo systemctl start keepalived
$ sudo systemctl enable keepalived
</code></pre><p>这里要注意，Keepalived启动时不会校验配置文件是否正确，所以我们要小心修改配置，防止出现意想不到的问题。</p><p>第五步，查看Keepalived的启动状态：</p><pre><code class="language-bash">$ systemctl status keepalived
</code></pre><p>输出中有<code>active (running)</code>字符串，说明成功启动。Keepalived的日志保存在<code>/var/log/messages</code>中，你有需要的话可以查看。</p><h3>Keepalived配置文件解析</h3><p>Keepalived的默认配置文件为<code>/etc/keepalived/keepalived.conf</code>，下面是一个Keepalived配置：</p><pre><code class="language-plain"># 全局定义，定义全局的配置选项
global_defs {
# 指定keepalived在发生切换操作时发送email，发送给哪些email
# 建议在keepalived_notify.sh中发送邮件
&nbsp; notification_email {
&nbsp; &nbsp; acassen@firewall.loc
&nbsp; }
&nbsp; notification_email_from Alexandre.Cassen@firewall.loc # 发送email时邮件源地址
&nbsp; &nbsp; smtp_server 192.168.200.1 # 发送email时smtp服务器地址
&nbsp; &nbsp; smtp_connect_timeout 30 # 连接smtp的超时时间
&nbsp; &nbsp; router_id VM-4-21-centos # 机器标识，通常可以设置为hostname
&nbsp; &nbsp; vrrp_skip_check_adv_addr # 如果接收到的报文和上一个报文来自同一个路由器，则不执行检查。默认是跳过检查
&nbsp; &nbsp; vrrp_garp_interval 0 # 单位秒，在一个网卡上每组gratuitous arp消息之间的延迟时间，默认为0
&nbsp; &nbsp; vrrp_gna_interval 0 # 单位秒，在一个网卡上每组na消息之间的延迟时间，默认为0
}
# 检测脚本配置
vrrp_script checkhaproxy
{
&nbsp; script "/etc/keepalived/check_nginx.sh" # 检测脚本路径
&nbsp; &nbsp; interval 5 # 检测时间间隔（秒）
&nbsp; &nbsp; weight 0 # 根据该权重改变priority，当值为0时，不改变实例的优先级
}
# VRRP实例配置
vrrp_instance VI_1 {
&nbsp; state BACKUP&nbsp; # 设置初始状态为'备份'
&nbsp; &nbsp; interface eth0 # 设置绑定VIP的网卡，例如eth0
&nbsp; &nbsp; virtual_router_id 51&nbsp; # 配置集群VRID，互为主备的VRID需要是相同的值
&nbsp; &nbsp; nopreempt&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# 设置非抢占模式，只能设置在state为backup的节点上
&nbsp; &nbsp; priority 50 # 设置优先级，值范围0～254，值越大优先级越高，最高的为master
&nbsp; &nbsp; advert_int 1 # 组播信息发送时间间隔，两个节点必须设置一样，默认为1秒
# 验证信息，两个节点必须一致
&nbsp; &nbsp; authentication {
&nbsp; &nbsp; &nbsp; auth_type PASS # 认证方式，可以是PASS或AH两种认证方式
&nbsp; &nbsp; &nbsp; &nbsp; auth_pass 1111 # 认证密码
&nbsp; &nbsp; }
&nbsp; unicast_src_ip 10.0.4.21&nbsp; # 设置本机内网IP地址
&nbsp; &nbsp; unicast_peer {
&nbsp; &nbsp; &nbsp; 10.0.4.20&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# 对端设备的IP地址
&nbsp; &nbsp; }
# VIP，当state为master时添加，当state为backup时删除
&nbsp; virtual_ipaddress {
&nbsp; &nbsp; 10.0.4.99 # 设置高可用虚拟VIP，如果是腾讯云的CVM，需要填写控制台申请到的HAVIP地址。
&nbsp; }
&nbsp; notify_master "/etc/keepalived/keepalived_notify.sh MASTER" # 当切换到master状态时执行脚本
&nbsp; &nbsp; notify_backup "/etc/keepalived/keepalived_notify.sh BACKUP" # 当切换到backup状态时执行脚本
&nbsp; &nbsp; notify_fault "/etc/keepalived/keepalived_notify.sh FAULT" # 当切换到fault状态时执行脚本
&nbsp; &nbsp; notify_stop "/etc/keepalived/keepalived_notify.sh STOP" # 当切换到stop状态时执行脚本
&nbsp; &nbsp; garp_master_delay 1&nbsp; &nbsp; # 设置当切为主状态后多久更新ARP缓存
&nbsp; &nbsp; garp_master_refresh 5&nbsp; &nbsp;# 设置主节点发送ARP报文的时间间隔
&nbsp; &nbsp; # 跟踪接口，里面任意一块网卡出现问题，都会进入故障(FAULT)状态
&nbsp; &nbsp; track_interface {
&nbsp; &nbsp; &nbsp; eth0
&nbsp; &nbsp; }
&nbsp; # 要执行的检查脚本
&nbsp; track_script {
&nbsp; &nbsp; checkhaproxy
&nbsp; }
}
</code></pre><p>这里解析下配置文件，大致分为下面4个部分。</p><ul>
<li>global_defs：全局定义，定义全局的配置选项。</li>
<li>vrrp_script checkhaproxy：检测脚本配置。</li>
<li>vrrp_instance VI_1：VRRP实例配置。</li>
<li>virtual_server：LVS配置。如果没有配置LVS+Keepalived，就不用设置这个选项。这门课中，我们使用Nginx代替LVS，所以无需配置<code>virtual_server</code>（配置示例中不再展示）。</li>
</ul><p>只有在网络故障或者自身出问题时，Keepalived才会进行VIP切换。但实际生产环境中，我们往往使用Keepalived来监控其他进程，当业务进程出故障时切换VIP，从而保障业务进程的高可用。</p><p>为了让Keepalived感知到Nginx的运行状况，我们需要指定<code>vrrp_script</code>脚本，<code>vrrp_script</code>脚本可以根据退出码，判断Nginx进程是否正常，<code>0</code>正常，非<code>0</code>不正常。当不正常时，Keepalived会进行VIP切换。为了实现业务进程的监控，我们需要设置<code>vrrp_script</code>和<code>track_script</code>：</p><pre><code class="language-plain">vrrp_script checkhaproxy
{
&nbsp; &nbsp; script "/etc/keepalived/check_nginx.sh"
&nbsp; &nbsp; interval 3
&nbsp; &nbsp; weight -20
}

vrrp_instance test
{
&nbsp; &nbsp; ...
&nbsp; &nbsp; track_script
&nbsp; &nbsp; {
&nbsp; &nbsp; &nbsp; &nbsp; checkhaproxy
&nbsp; &nbsp; }
&nbsp; &nbsp; ...
}
</code></pre><p>这里，我介绍下上面配置中的一些配置项。</p><ul>
<li>script：指定脚本路径。</li>
<li>interval：表示Keepalived执行脚本的时间间隔（秒）。</li>
<li>weight：检测权重，可以改变<code>priority</code>的值。例如，<code>-20</code>表示检测失败时，优先级<code>-20</code>，成功时不变。<code>20</code>表示检测成功时，优先级<code>+20</code>，失败时不变。</li>
</ul><h2>总结</h2><p>今天我主要讲了跟IAM部署相关的两个组件，Nginx + Keepalived的相关功能。</p><p>我们可以基于物理机/虚拟机来部署IAM应用，在部署IAM应用时，需要确保整个应用具备高可用和弹性扩缩容能力。你可以通过Nginx的反向代理功能和负载均衡功能实现后端服务iam-apiserver和iam-authz-server的高可用，通过Keepalived实现Nginx的高可用，通过Nginx + Keepalived组合，来实现IAM应用的高可用和弹性伸缩能力。</p><h2>课后练习</h2><ol>
<li>Keepalived的主备服务器要接在同一个交换机上。思考下，如果交换机故障，如何实现整个系统的高可用？</li>
<li>iam-pump是有状态的服务，思考下，如何实现iam-pump的高可用？</li>
</ol><p>欢迎你在留言区与我交流讨论，我们下一讲见。</p><h2>精选留言：</h2>
        <ul>
        
<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            Realm  2021-08-26 07:41:35
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            1 可以把交换机搞成堆叠模式，服务器分别接在两个不同的交换机上，可以减少单点故障。可以看看这篇文章https:&#47;&#47;blog.51cto.com&#47;netlt&#47;2589364<br><br>2 有状态一般是cookie或者session，负载均衡支持基于cookie的会话保持，开启后，相同cookie的http请求，始终打到某一个服务端.<br><br>请老师指点！ [3赞]
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;        line-height:1.2">作者回复2021-08-28 09:09:54</div>
    <div style="color:#353535;font-weight:400;white-space:normal;        word-break:break-all;line-height:1.6">高抬不通交换机的机器，一台出故障，另一台可以手动切换</div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            kkgo  2021-08-27 10:17:30
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            怎么做nginx负载均衡？ 
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;        line-height:1.2">作者回复2021-08-28 09:03:27</div>
    <div style="color:#353535;font-weight:400;white-space:normal;        word-break:break-all;line-height:1.6">老哥，请看下一讲</div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            daz2yy  2021-08-27 07:43:07
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            Nginx 确保服务的高可用；<br>Keepalived 确保 Nginx 的高可用；<br>谁来保证 Keepalived 的高可用呢？感觉如果能确保 Keepalived 的高可用，那么去掉这一层，把保证 Keepalived 高可用的方式应用到保证 Nginx 的高可用上不是简单一些吗？ 
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;        line-height:1.2">作者回复2021-08-28 09:06:08</div>
    <div style="color:#353535;font-weight:400;white-space:normal;        word-break:break-all;line-height:1.6">Nginx不带VIP的能力。Keepalived的高可用通过VRRP技术来实现的</div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            XI  2021-08-26 21:54:28
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            老师，单台gin框架应该起多少goroutine性能才是最优的啊，100 个1000个？，单台服务器起能抗住多少的并发啊？ 
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;        line-height:1.2">作者回复2021-08-28 09:06:41</div>
    <div style="color:#353535;font-weight:400;white-space:normal;        word-break:break-all;line-height:1.6">具体要看机器配置了。你可以参考2C8G的并发</div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            那时刻  2021-08-26 10:33:19
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            对于如果交换机故障，如何实现整个系统的高可用？<br><br>其一采用备份交换机，当云解析到主交换机不同之后，把请求路由到备份交换机上，主交换机和备份交换机都指向同一后台服务器<br><br>其二可以采用备份服务器集群，与主服务器集群一致，备灾使用 
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;        line-height:1.2">作者回复2021-08-28 09:07:05</div>
    <div style="color:#353535;font-weight:400;white-space:normal;        word-break:break-all;line-height:1.6">对的，只能采用冷备了。</div>
</div>
            
    </div>
</li>
            </ul>
</div>
</body>
</html>