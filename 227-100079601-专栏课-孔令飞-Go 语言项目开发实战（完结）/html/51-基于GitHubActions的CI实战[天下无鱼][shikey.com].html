<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <!--<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>-->
    <title>51-基于GitHubActions的CI实战</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <style>
        html {
            color: #333;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-rendering: optimizelegibility;
            font-family: Helvetica Neue, PingFang SC, Verdana, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, sans-serif
        }

        html.borderbox *,
        html.borderbox :after,
        html.borderbox :before {
            box-sizing: border-box
        }

        article,
        aside,
        blockquote,
        body,
        button,
        code,
        dd,
        details,
        dl,
        dt,
        fieldset,
        figcaption,
        figure,
        footer,
        form,
        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        header,
        hr,
        input,
        legend,
        li,
        menu,
        nav,
        ol,
        p,
        pre,
        section,
        td,
        textarea,
        th,
        ul {
            margin: 0;
            padding: 0
        }

        article,
        aside,
        details,
        figcaption,
        figure,
        footer,
        header,
        menu,
        nav,
        section {
            display: block
        }

        audio,
        canvas,
        video {
            display: inline-block
        }

        body,
        button,
        input,
        select,
        textarea {
            font: 300 1em/1.8 PingFang SC, Lantinghei SC, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, Helvetica, sans-serif
        }

        button::-moz-focus-inner,
        input::-moz-focus-inner {
            padding: 0;
            border: 0
        }

        table {
            border-collapse: collapse;
            border-spacing: 0
        }

        fieldset,
        img {
            border: 0
        }

        blockquote {
            position: relative;
            color: #999;
            font-weight: 400;
            border-left: 1px solid #1abc9c;
            padding-left: 1em;
            margin: 1em 3em 1em 2em
        }

        @media only screen and (max-width: 640px) {
            blockquote {
                margin: 1em 0
            }
        }

        abbr,
        acronym {
            border-bottom: 1px dotted;
            font-variant: normal
        }

        abbr {
            cursor: help
        }

        del {
            text-decoration: line-through
        }

        address,
        caption,
        cite,
        code,
        dfn,
        em,
        th,
        var {
            font-style: normal;
            font-weight: 400
        }

        ol,
        ul {
            list-style: none
        }

        caption,
        th {
            text-align: left
        }

        q:after,
        q:before {
            content: ""
        }

        sub,
        sup {
            font-size: 75%;
            line-height: 0;
            position: relative
        }

        :root sub,
        :root sup {
            vertical-align: baseline
        }

        sup {
            top: -.5em
        }

        sub {
            bottom: -.25em
        }

        a {
            color: #1abc9c
        }

        a:hover {
            text-decoration: underline
        }

        .typo a {
            border-bottom: 1px solid #1abc9c
        }

        .typo a:hover {
            border-bottom-color: #555;
            color: #555
        }

        .typo a:hover,
        a,
        ins {
            text-decoration: none
        }

        .typo-u,
        u {
            text-decoration: underline
        }

        mark {
            background: #fffdd1;
            border-bottom: 1px solid #ffedce;
            padding: 2px;
            margin: 0 5px
        }

        code,
        pre,
        pre tt {
            font-family: Courier, Courier New, monospace
        }

        pre {
            background: hsla(0, 0%, 97%, .7);
            border: 1px solid #ddd;
            padding: 1em 1.5em;
            display: block;
            -webkit-overflow-scrolling: touch
        }

        hr {
            border: none;
            border-bottom: 1px solid #cfcfcf;
            margin-bottom: .8em;
            height: 10px
        }

        .typo-small,
        figcaption,
        small {
            font-size: .9em;
            color: #888
        }

        b,
        strong {
            font-weight: 700;
            color: #000
        }

        [draggable] {
            cursor: move
        }

        .clearfix:after,
        .clearfix:before {
            content: "";
            display: table
        }

        .clearfix:after {
            clear: both
        }

        .clearfix {
            zoom: 1
        }

        .textwrap,
        .textwrap td,
        .textwrap th {
            word-wrap: break-word;
            word-break: break-all
        }

        .textwrap-table {
            table-layout: fixed
        }

        .serif {
            font-family: Palatino, Optima, Georgia, serif
        }

        .typo-dl,
        .typo-form,
        .typo-hr,
        .typo-ol,
        .typo-p,
        .typo-pre,
        .typo-table,
        .typo-ul,
        .typo dl,
        .typo form,
        .typo hr,
        .typo ol,
        .typo p,
        .typo pre,
        .typo table,
        .typo ul,
        blockquote {
            margin-bottom: 1rem
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: PingFang SC, Helvetica Neue, Verdana, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, sans-serif;
            color: #000;
            line-height: 1.35
        }

        .typo-h1,
        .typo-h2,
        .typo-h3,
        .typo-h4,
        .typo-h5,
        .typo-h6,
        .typo h1,
        .typo h2,
        .typo h3,
        .typo h4,
        .typo h5,
        .typo h6 {
            margin-top: 1.2em;
            margin-bottom: .6em;
            line-height: 1.35
        }

        .typo-h1,
        .typo h1 {
            font-size: 2em
        }

        .typo-h2,
        .typo h2 {
            font-size: 1.8em
        }

        .typo-h3,
        .typo h3 {
            font-size: 1.6em
        }

        .typo-h4,
        .typo h4 {
            font-size: 1.4em
        }

        .typo-h5,
        .typo-h6,
        .typo h5,
        .typo h6 {
            font-size: 1.2em
        }

        .typo-ul,
        .typo ul {
            margin-left: 1.3em;
            list-style: disc
        }

        .typo-ol,
        .typo ol {
            list-style: decimal;
            margin-left: 1.9em
        }

        .typo-ol ol,
        .typo-ol ul,
        .typo-ul ol,
        .typo-ul ul,
        .typo li ol,
        .typo li ul {
            margin-bottom: .8em;
            margin-left: 2em
        }

        .typo-ol ul,
        .typo-ul ul,
        .typo li ul {
            list-style: circle
        }

        .typo-table td,
        .typo-table th,
        .typo table caption,
        .typo table td,
        .typo table th {
            border: 1px solid #ddd;
            padding: .5em 1em;
            color: #666
        }

        .typo-table th,
        .typo table th {
            background: #fbfbfb
        }

        .typo-table thead th,
        .typo table thead th {
            background: hsla(0, 0%, 95%, .7)
        }

        .typo table caption {
            border-bottom: none
        }

        .typo-input,
        .typo-textarea {
            -webkit-appearance: none;
            border-radius: 0
        }

        .typo-em,
        .typo em,
        caption,
        legend {
            color: #000;
            font-weight: inherit
        }

        .typo-em {
            position: relative
        }

        .typo-em:after {
            position: absolute;
            top: .65em;
            left: 0;
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
            content: "\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB"
        }

        .typo img {
            max-width: 100%
        }

        .common-content {
            font-weight: 400;
            color: #353535;
            line-height: 1.75rem;
            white-space: normal;
            word-break: normal;
            font-size: 1rem
        }

        .common-content img {
            display: block;
            max-width: 100%;
            background-color: #eee
        }

        .common-content audio,
        .common-content video {
            width: 100%;
            background-color: #eee
        }

        .common-content center,
        .common-content font {
            margin-top: 1rem;
            display: inline-block
        }

        .common-content center {
            width: 100%
        }

        .common-content pre {
            margin-top: 1rem;
            padding-left: 0;
            padding-right: 0;
            position: relative;
            overflow: hidden
        }

        .common-content pre code {
            font-size: .8rem;
            font-family: Consolas, Liberation Mono, Menlo, monospace, Courier;
            display: block;
            width: 100%;
            box-sizing: border-box;
            padding-left: 1rem;
            padding-right: 1rem;
            overflow-x: auto
        }

        .common-content hr {
            border: none;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            border-top: 1px solid #f5f5f5;
            height: 1px;
            background: none
        }

        .common-content b,
        .common-content h1,
        .common-content h2,
        .common-content h3,
        .common-content h4,
        .common-content h5,
        .common-content strong {
            font-weight: 700
        }

        .common-content h1,
        .common-content h2 {
            font-size: 1.125rem;
            margin-bottom: .45rem
        }

        .common-content h3,
        .common-content h4,
        .common-content h5 {
            font-size: 1rem;
            margin-bottom: .45rem
        }

        .common-content p {
            font-weight: 400;
            color: #353535;
            margin-top: .15rem
        }

        .common-content .orange {
            color: #ff5a05
        }

        .common-content .reference {
            font-size: 1rem;
            color: #888
        }

        .custom-rich-content h1 {
            margin-top: 0;
            font-weight: 400;
            font-size: 15.25px;
            border-bottom: 1px solid #eee;
            line-height: 2.8
        }

        .custom-rich-content li,
        .custom-rich-content p {
            font-size: 14px;
            color: #888;
            line-height: 1.6
        }

        table.hljs-ln {
            margin-bottom: 0;
            border-spacing: 0;
            border-collapse: collapse
        }

        table.hljs-ln,
        table.hljs-ln tbody,
        table.hljs-ln td,
        table.hljs-ln tr {
            box-sizing: border-box
        }

        table.hljs-ln td {
            padding: 0;
            border: 0
        }

        table.hljs-ln td.hljs-ln-numbers {
            min-width: 15px;
            color: rgba(27, 31, 35, .3);
            text-align: right;
            white-space: nowrap;
            cursor: pointer;
            user-select: none
        }

        table.hljs-ln td.hljs-ln-code,
        table.hljs-ln td.hljs-ln-numbers {
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, Courier, monospace;
            font-size: 12px;
            line-height: 20px;
            vertical-align: top
        }

        table.hljs-ln td.hljs-ln-code {
            position: relative;
            padding-right: 10px;
            padding-left: 10px;
            overflow: visible;
            color: #24292e;
            word-wrap: normal;
            white-space: pre
        }

        video::-webkit-media-controls {
            overflow: hidden !important
        }

        video::-webkit-media-controls-enclosure {
            width: calc(100% + 32px);
            margin-left: auto
        }

        ._29HP61GA_0 {
            max-width:800px;
            margin:0 auto;
            margin-bottom: 20px;
            font-weight: 400;
            color: #353535;
            line-height: 1.76;
            white-space: normal;
            word-break: normal;
            font-size: 17px;
            -webkit-transition: background-color .3s ease;
            transition: background-color .3s ease
        }

        ._29HP61GA_0 .MathJax_Display {
            overflow: auto
        }

        ._29HP61GA_0 .poster {
            position: fixed;
            left: -10000px;
            top: -10000px;
            overflow: hidden;
            padding: 1rem;
            background: #ececec
        }

        ._29HP61GA_0 .richcontent-pre-copy {
            font-size: 13px;
            color: #888;
            position: absolute;
            right: 1em;
            top: .5em;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none
        }

        ._29HP61GA_0 .richcontent-pre-copy .iconfont {
            font-size: 12px;
            margin-right: .2em
        }

        ._29HP61GA_0 a {
            color: #fa8919;
            border-bottom: 1px solid #fa8919
        }

        ._29HP61GA_0 img {
            display: block;
            max-width: 100%;
            position: relative;
            left: 50%;
            -webkit-transform: translateX(-50%);
            transform: translateX(-50%);
            background-color: #eee;
            vertical-align: top;
            border-radius: 0
        }

        ._29HP61GA_0 audio,
        ._29HP61GA_0 video {
            width: 100%;
            background-color: #eee
        }

        ._29HP61GA_0 pre {
            margin-top: 16px;
            padding: 34px 0 0;
            margin-bottom: 30px;
            position: relative;
            border-radius: 6px;
            background: rgba(246, 247, 251, .749);
            border: 0
        }

        ._29HP61GA_0 pre code {
            font-size: 12px;
            font-family: Consolas, Liberation Mono, Menlo, monospace, Courier;
            display: block;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
            margin-left: 16px;
            margin-right: 16px;
            overflow-x: scroll
        }

        ._29HP61GA_0 pre code:after {
            content: "";
            height: 30px;
            width: 100%;
            display: block
        }

        ._29HP61GA_0 hr {
            border: none;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            border-top: 1px solid #f5f5f5;
            height: 1px;
            background: none
        }

        ._29HP61GA_0 h1,
        ._29HP61GA_0 h2,
        ._29HP61GA_0 h3,
        ._29HP61GA_0 h4,
        ._29HP61GA_0 h5 {
            margin-bottom: 20px;
            margin-top: 0;
            font-weight: 700
        }

        ._29HP61GA_0 b,
        ._29HP61GA_0 strong {
            font-weight: 700
        }

        ._29HP61GA_0 h1 {
            font-size: 21px
        }

        ._29HP61GA_0 h2 {
            font-size: 20px
        }

        ._29HP61GA_0 h3 {
            font-size: 19px
        }

        ._29HP61GA_0 h4 {
            font-size: 18px
        }

        ._29HP61GA_0 h5 {
            font-size: 17px
        }

        ._29HP61GA_0 center,
        ._29HP61GA_0 p {
            font-weight: 400;
            color: #353535;
            margin-top: 0;
            margin-bottom: 30px;
            word-break: break-word
        }

        ._29HP61GA_0 center {
            text-align: center
        }

        ._29HP61GA_0 blockquote {
            margin-top: 0;
            margin-bottom: 34px;
            border-left: 3px solid #e8e8e8;
            padding-left: 17px;
            color: #353535
        }

        ._29HP61GA_0 blockquote p {
            margin-top: 0;
            margin-bottom: 0
        }

        ._29HP61GA_0 ol,
        ._29HP61GA_0 ul {
            margin-bottom: 30px
        }

        ._29HP61GA_0 ol p,
        ._29HP61GA_0 ul p {
            margin-top: 0;
            margin-bottom: 0
        }

        ._29HP61GA_0 ol {
            list-style: decimal;
            margin-left: 20px
        }

        ._29HP61GA_0 ul li {
            padding-left: 17px;
            position: relative;
            margin-bottom: 10px
        }

        ._29HP61GA_0 ul li:after {
            content: "";
            height: 6px;
            width: 6px;
            border-radius: 50%;
            background: #353535;
            position: absolute;
            top: 10px;
            left: 0
        }

        ._29HP61GA_0 .orange {
            color: #fa8919
        }

        ._29HP61GA_0 .reference {
            color: #888
        }

        ._29HP61GA_0 .m-right {
            text-align: right
        }

        ._29HP61GA_0 .m-center {
            text-align: center;
            display: block
        }

        ._29HP61GA_0 .m-gray {
            color: #888
        }

        ._29HP61GA_0 .m-small {
            font-size: 15px
        }

        ._29HP61GA_0 table.hljs-ln {
            margin-bottom: 0;
            border-spacing: 0;
            border-collapse: collapse
        }

        ._29HP61GA_0 table.hljs-ln,
        ._29HP61GA_0 table.hljs-ln tbody,
        ._29HP61GA_0 table.hljs-ln td,
        ._29HP61GA_0 table.hljs-ln tr {
            -webkit-box-sizing: border-box;
            box-sizing: border-box
        }

        ._29HP61GA_0 table.hljs-ln td {
            padding: 0;
            border: 0
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-numbers {
            min-width: 15px;
            font-size: 12px;
            color: rgba(27, 31, 35, .3);
            text-align: right;
            white-space: nowrap;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-code,
        ._29HP61GA_0 table.hljs-ln td.hljs-ln-numbers {
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, Courier, monospace;
            line-height: 20px;
            vertical-align: top
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-code {
            position: relative;
            padding-right: 10px;
            padding-left: 10px;
            overflow: visible;
            font-size: 13px;
            color: #666;
            word-wrap: normal;
            white-space: pre
        }

    </style>
</head>
<body>
<div class="_29HP61GA_0">
<h1>51-基于GitHubActions的CI实战</h1>
<p>你好，我是孔令飞。这是本专栏正文的最后一讲了，恭喜你坚持到了最后！</p><p>在Go项目开发中，我们要频繁地执行静态代码检查、测试、编译、构建等操作。如果每一步我们都手动执行，效率低不说，还容易出错。所以，我们通常借助CI系统来自动化执行这些操作。</p><p>当前业界有很多优秀的CI系统可供选择，例如 <a href="https://circleci.com/">CircleCI</a>、<a href="https://travis-ci.org/">TravisCI</a>、<a href="https://github.com/jenkinsci/jenkins">Jenkins</a>、<a href="https://coding.net/">CODING</a>、<a href="https://github.com/features/actions">GitHub Actions</a> 等。这些系统在设计上大同小异，为了减少你的学习成本，我选择了相对来说容易实践的GitHub Actions，来给你展示如何通过CI来让工作自动化。</p><p>这一讲，我会先介绍下GitHub Actions及其用法，再向你展示一个CI示例，最后给你演示下IAM是如何构建CI任务的。</p><h2>GitHub Actions的基本用法</h2><p>GitHub Actions是GitHub为托管在github.com站点的项目提供的持续集成服务，于2018年10月推出。</p><p>GitHub Actions具有以下功能特性：</p><ul>
<li>提供原子的actions配置和组合actions的workflow配置两种能力。</li>
<li>全局配置基于<a href="https://help.github.com/en/articles/migrating-github-actions-from-hcl-syntax-to-yaml-syntax">YAML配置</a>，兼容主流CI/CD工具配置。</li>
<li>Actions/Workflows基于<a href="https://help.github.com/en/articles/events-that-trigger-workflows">事件触发</a>，包括Event restrictions、Webhook events、Scheduled events、External events。</li>
<li>提供可供运行的托管容器服务，包括Docker、VM，可运行Linux、macOS、Windows主流系统。</li>
<li>提供主流语言的支持，包括Node.js、Python、Java、Ruby、PHP、Go、Rust、.NET。</li>
<li>提供实时日志流程，方便调试。</li>
<li>提供<a href="https://help.github.com/en/articles/about-github-actions#discovering-actions-in-the-github-community">平台内置的Actions</a>与第三方提供的Actions，开箱即用。</li>
</ul><!-- [[[read_end]]] --><h3>GitHub Actions的基本概念</h3><p>在构建持续集成任务时，我们会在任务中心完成各种操作，比如克隆代码、编译代码、运行单元测试、构建和发布镜像等。GitHub把这些操作称为Actions。</p><p>Actions在很多项目中是可以共享的，GitHub允许开发者将这些可共享的Actions上传到<a href="https://github.com/marketplace?type=actions">GitHub的官方Actions市场</a>，开发者在Actions市场中可以搜索到他人提交的 Actions。另外，还有一个 <a href="https://github.com/sdras/awesome-actions">awesome actions</a> 的仓库，里面也有不少的Action可供开发者使用。如果你需要某个 Action，不必自己写复杂的脚本，直接引用他人写好的 Action 即可。整个持续集成过程，就变成了一个 Actions 的组合。</p><p>Action其实是一个独立的脚本，可以将Action存放在GitHub代码仓库中，通过<code>&lt;userName&gt;/&lt;repoName&gt;</code>的语法引用 Action。例如，<code>actions/checkout@v2</code>表示<code>https://github.com/actions/checkout</code>这个仓库，tag是v2。<code>actions/checkout@v2</code>也代表一个 Action，作用是安装 Go编译环境。GitHub 官方的 Actions 都放在 <a href="https://github.com/actions">github.com/actions</a> 里面。</p><p>GitHub Actions 有一些自己的术语，下面我来介绍下。</p><ul>
<li>workflow（工作流程）：一个  <code>.yml</code>  文件对应一个 workflow，也就是一次持续集成。一个 GitHub 仓库可以包含多个 workflow，只要是在  <code>.github/workflow</code>  目录下的  <code>.yml</code>  文件都会被 GitHub 执行。</li>
<li>job（任务）：一个 workflow 由一个或多个 job 构成，每个 job 代表一个持续集成任务。</li>
<li>step（步骤）：每个 job 由多个 step 构成，一步步完成。</li>
<li>action（动作）：每个 step 可以依次执行一个或多个命令（action）。</li>
<li>on：一个 workflow 的触发条件，决定了当前的 workflow 在什么时候被执行。</li>
</ul><h3>workflow文件介绍</h3><p>GitHub Actions 配置文件存放在代码仓库的<code>.github/workflows</code>目录下，文件后缀为<code>.yml</code>，支持创建多个文件，文件名可以任意取，比如<code>iam.yml</code>。GitHub 只要发现<code>.github/workflows</code>目录里面有<code>.yml</code>文件，就会自动运行该文件，如果运行过程中存在问题，会以邮件的形式通知到你。</p><p>workflow 文件的配置字段非常多，如果你想详细了解，可以查看<a href="https://docs.github.com/cn/actions/reference/workflow-syntax-for-github-actions">官方文档</a>。这里，我来介绍一些基本的配置字段。</p><ol>
<li><code>name</code></li>
</ol><p><code>name</code>字段是 workflow 的名称。如果省略该字段，默认为当前 workflow 的文件名。</p><pre><code class="language-yaml">name: GitHub Actions Demo
</code></pre><ol start="2">
<li><code>on</code></li>
</ol><p><code>on</code>字段指定触发 workflow 的条件，通常是某些事件。</p><pre><code class="language-yaml">on: push
</code></pre><p>上面的配置意思是，<code>push</code>事件触发 workflow。<code>on</code>字段也可以是事件的数组，例如:</p><pre><code class="language-yaml">on: [push, pull_request]
</code></pre><p>上面的配置意思是，<code>push</code>事件或<code>pull_request</code>事件都可以触发 workflow。</p><p>想了解完整的事件列表，你可以查看<a href="https://docs.github.com/en/actions/reference/events-that-trigger-workflows">官方文档</a>。除了代码库事件，GitHub Actions 也支持外部事件触发，或者定时运行。</p><ol start="3">
<li><code>on.&lt;push|pull_request&gt;.&lt;tags|branches&gt;</code></li>
</ol><p>指定触发事件时，我们可以限定分支或标签。</p><pre><code class="language-yaml">on:
  push:
    branches:
      - master
</code></pre><p>上面的配置指定，只有<code>master</code>分支发生<code>push</code>事件时，才会触发 workflow。</p><ol start="4">
<li><code>jobs.&lt;job_id&gt;.name</code></li>
</ol><p>workflow 文件的主体是<code>jobs</code>字段，表示要执行的一项或多项任务。</p><p><code>jobs</code>字段里面，需要写出每一项任务的<code>job_id</code>，具体名称自定义。<code>job_id</code>里面的<code>name</code>字段是任务的说明。</p><pre><code class="language-yaml">jobs:
  my_first_job:
    name: My first job
  my_second_job:
    name: My second job
</code></pre><p>上面的代码中，<code>jobs</code>字段包含两项任务，<code>job_id</code>分别是<code>my_first_job</code>和<code>my_second_job</code>。</p><ol start="5">
<li><code>jobs.&lt;job_id&gt;.needs</code></li>
</ol><p><code>needs</code>字段指定当前任务的依赖关系，即运行顺序。</p><pre><code class="language-yaml">jobs:
  job1:
  job2:
    needs: job1
  job3:
    needs: [job1, job2]
</code></pre><p>上面的代码中，<code>job1</code>必须先于<code>job2</code>完成，而<code>job3</code>等待<code>job1</code>和<code>job2</code>完成后才能运行。因此，这个 workflow 的运行顺序为：<code>job1</code>、<code>job2</code>、<code>job3</code>。</p><ol start="6">
<li><code>jobs.&lt;job_id&gt;.runs-on</code></li>
</ol><p><code>runs-on</code>字段指定运行所需要的虚拟机环境，它是必填字段。目前可用的虚拟机如下：</p><ul>
<li>ubuntu-latest、ubuntu-18.04或ubuntu-16.04。</li>
<li>windows-latest、windows-2019或windows-2016。</li>
<li>macOS-latest或macOS-10.14。</li>
</ul><p>下面的配置指定虚拟机环境为<code>ubuntu-18.04</code>。</p><pre><code class="language-yaml">runs-on: ubuntu-18.04
</code></pre><ol start="7">
<li><code>jobs.&lt;job_id&gt;.steps</code></li>
</ol><p><code>steps</code>字段指定每个 Job 的运行步骤，可以包含一个或多个步骤。每个步骤都可以指定下面三个字段。</p><ul>
<li><code>jobs.&lt;job_id&gt;.steps.name</code>：步骤名称。</li>
<li><code>jobs.&lt;job_id&gt;.steps.run</code>：该步骤运行的命令或者 action。</li>
<li><code>jobs.&lt;job_id&gt;.steps.env</code>：该步骤所需的环境变量。</li>
</ul><p>下面是一个完整的 workflow 文件的范例：</p><pre><code class="language-yaml">name: Greeting from Mona
on: push

jobs:
  my-job:
    name: My Job
    runs-on: ubuntu-latest
    steps:
    - name: Print a greeting
      env:
        MY_VAR: Hello! My name is
        FIRST_NAME: Lingfei
        LAST_NAME: Kong
      run: |
        echo $MY_VAR $FIRST_NAME $LAST_NAME.
</code></pre><p>上面的代码中，<code>steps</code>字段只包括一个步骤。该步骤先注入三个环境变量，然后执行一条 Bash 命令。</p><ol start="8">
<li><code>uses</code></li>
</ol><p><code>uses</code> 可以引用别人已经创建的 actions，就是上面说的 actions 市场中的 actions。引用格式为<code>userName/repoName@verison</code>，例如<code>uses: actions/setup-go@v1</code>。</p><ol start="9">
<li><code>with</code></li>
</ol><p><code>with</code> 指定actions的输入参数。每个输入参数都是一个键/值对。输入参数被设置为环境变量，该变量的前缀为 <code>INPUT_</code>，并转换为大写。</p><p>这里举个例子：我们定义 <code>hello_world</code> 操作所定义的三个输入参数（<code>first_name</code>、<code>middle_name</code> 和 <code>last_name</code>），这些输入变量将被 <code>hello-world</code> 操作作为 <code>INPUT_FIRST_NAME</code>、<code>INPUT_MIDDLE_NAME</code> 和 <code>INPUT_LAST_NAME</code> 环境变量使用。</p><pre><code class="language-yaml">jobs:
  my_first_job:
    steps:
      - name: My first step
        uses: actions/hello_world@master
        with:
          first_name: Lingfei
          middle_name: Go
          last_name: Kong
</code></pre><ol start="10">
<li><code>run</code></li>
</ol><p><code>run</code>指定执行的命令。可以有多个命令，例如：</p><pre><code class="language-yaml">- name: Build
      run: |
      go mod tidy
      go build -v -o helloci .
</code></pre><ol start="11">
<li><code>id</code></li>
</ol><p><code>id</code>是step的唯一标识。</p><h2>GitHub Actions的进阶用法</h2><p>上面，我介绍了GitHub Actions的一些基本知识，这里我再介绍下GitHub Actions的进阶用法。</p><h3>为工作流加一个Badge</h3><p>在action的面板中，点击<code>Create status badge</code>就可以复制Badge的Markdown内容到README.md中。</p><p>之后，我们就可以直接在README.md中看到当前的构建结果：</p><p><img src="https://static001.geekbang.org/resource/image/45/af/453a97b0776281873dee5671c53347af.png?wh=1280x765" alt="图片"></p><h3>使用构建矩阵</h3><p>如果我们想在多个系统或者多个语言版本上测试构建，就需要设置构建矩阵。例如，我们想在多个操作系统、多个Go版本下跑测试，可以使用如下workflow配置：</p><pre><code class="language-yaml">name: Go Test

on: [push, pull_request]

jobs:

  helloci-build:
    name: Test with go ${{ matrix.go_version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        go_version: [1.15, 1.16]
        os: [ubuntu-latest, macOS-latest]

    steps:

      - name: Set up Go ${{ matrix.go_version }}
        uses: actions/setup-go@v2
        with:
          go-version: ${{ matrix.go_version }}
        id: go
</code></pre><p>上面的workflow配置，通过<code>strategy.matrix</code>配置了该工作流程运行的环境矩阵（格式为<code>go_version.os</code>）：<code>ubuntu-latest.1.15</code>、<code>ubuntu-latest.1.16</code>、<code>macOS-latest.1.15</code>、<code>macOS-latest.1.16</code>。也就是说，会在4台不同配置的服务器上执行该workflow。</p><h3>使用Secrets</h3><p>在构建过程中，我们可能需要用到<code>ssh</code>或者<code>token</code>等敏感数据，而我们不希望这些数据直接暴露在仓库中，此时就可以使用<code>secrets</code>。</p><p>我们在对应项目中选择<code>Settings</code>-&gt; <code>Secrets</code>，就可以创建<code>secret</code>，如下图所示：</p><p><img src="https://static001.geekbang.org/resource/image/c0/d3/c00b11a1709838c1a205ace7976768d3.png?wh=1920x1046" alt="图片"></p><p>配置文件中的使用方法如下：</p><pre><code class="language-yaml">name: Go Test
on: [push, pull_request]
jobs:
  helloci-build:
    name: Test with go
    runs-on: [ubuntu-latest]
    environment:
      name: helloci
    steps:
      - name: use secrets
        env:
          super_secret: ${{ secrets.YourSecrets }}
</code></pre><p>secret name不区分大小写，所以如果新建secret的名字是name，使用时用 <code>secrets.name</code> 或者 <code>secrets.Name</code> 都是可以的。而且，就算此时直接使用 <code>echo</code> 打印 <code>secret</code> , 控制台也只会打印出<code>*</code>来保护secret。<br>
这里要注意，你的secret是属于某一个环境变量的，所以要指明环境的名字：<code>environment.name</code>。上面的workflow配置中的<code>secrets.YourSecrets</code>属于<code>helloci</code>环境。</p><h3>使用Artifact保存构建产物</h3><p>在构建过程中，我们可能需要输出一些构建产物，比如日志文件、测试结果等。这些产物可以使用Github Actions Artifact 来存储。你可以使用<a href="https://github.com/actions/upload-artifact">action/upload-artifact</a> 和 <a href="https://github.com/actions/download-artifact">download-artifact</a> 进行构建参数的相关操作。</p><p>这里我以输出Jest测试报告为例来演示下如何保存Artifact产物。Jest测试后的测试产物是coverage：</p><pre><code class="language-yaml">steps:
      - run: npm ci
      - run: npm test

      - name: Collect Test Coverage File
        uses: actions/upload-artifact@v1.0.0
        with:
          name: coverage-output
          path: coverage
</code></pre><p>执行成功后，我们就能在对应action面板看到生成的Artifact：</p><p><img src="https://static001.geekbang.org/resource/image/4c/66/4c4a8d6aec12a5dd1cdc80d238472566.png?wh=1280x208" alt="图片"></p><h2>GitHub Actions实战</h2><p>上面，我介绍了GitHub Actions的用法，接下来我们就来实战下，看下使用GitHub Actions的6个具体步骤。</p><p><strong>第一步，</strong>创建一个测试仓库。</p><p>登陆<a href="https://github.com/">GitHub官网</a>，点击<strong>New repository</strong>创建，如下图所示：</p><p><img src="https://static001.geekbang.org/resource/image/6d/a0/6d76d02f0418671a32f5346fccf616a0.png?wh=1920x810" alt="图片"></p><p>这里，我们创建了一个叫<code>helloci</code>的测试项目。</p><p><strong>第二步，</strong>将新的仓库 clone 下来，并添加一些文件：</p><pre><code class="language-bash">$ git clone https://github.com/marmotedu/helloci
</code></pre><p>你可以克隆<a href="https://github.com/marmotedu/helloci">marmotedu/helloci</a>，并将里面的文件拷贝到你创建的项目仓库中。</p><p><strong>第三步，</strong>创建GitHub Actions workflow配置目录：</p><pre><code class="language-bash">$ mkdir -p .github/workflows                     
</code></pre><p><strong>第四步，</strong>创建GitHub Actions workflow配置。</p><p>在<code>.github/workflows</code>目录下新建<code>helloci.yml</code>文件，内容如下：</p><pre><code class="language-yaml">name: Go Test

on: [push, pull_request]

jobs:

  helloci-build:
    name: Test with go ${{ matrix.go_version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    environment:
      name: helloci

    strategy:
      matrix:
        go_version: [1.16]
        os: [ubuntu-latest]

    steps:

      - name: Set up Go ${{ matrix.go_version }}
        uses: actions/setup-go@v2
        with:
          go-version: ${{ matrix.go_version }}
        id: go

      - name: Check out code into the Go module directory
        uses: actions/checkout@v2

      - name: Tidy
        run: |
          go mod tidy

      - name: Build
        run: |
          go build -v -o helloci .

      - name: Collect main.go file
        uses: actions/upload-artifact@v1.0.0
        with:
          name: main-output
          path: main.go

      - name: Publish to Registry
        uses: elgohr/Publish-Docker-GitHub-Action@master
        with:
          name: ccr.ccs.tencentyun.com/marmotedu/helloci:beta  # docker image 的名字
          username: ${{ secrets.DOCKER_USERNAME}} # 用户名
          password: ${{ secrets.DOCKER_PASSWORD }} # 密码
          registry: ccr.ccs.tencentyun.com # 腾讯云Registry
          dockerfile: Dockerfile # 指定 Dockerfile 的位置
          tag_names: true # 是否将 release 的 tag 作为 docker image 的 tag
</code></pre><p>上面的workflow文件定义了当GitHub仓库有<code>push</code>、<code>pull_request</code>事件发生时，会触发GitHub Actions工作流程，流程中定义了一个任务（Job）<code>helloci-build</code>，Job中包含了多个步骤（Step），每个步骤又包含一些动作（Action）。</p><p>上面的workflow配置会按顺序执行下面的6个步骤。</p><ol>
<li>准备一个Go编译环境。</li>
<li>从<a href="https://github.com/marmotedu/helloci">marmotedu/helloci</a>下载源码。</li>
<li>添加或删除缺失的依赖包。</li>
<li>编译Go源码。</li>
<li>上传构建产物。</li>
<li>构建镜像，并将镜像push到<code>ccr.ccs.tencentyun.com/marmotedu/helloci:beta</code>。</li>
</ol><p><strong>第五步，</strong>在push代码之前，我们需要先创建<code>DOCKER_USERNAME</code>和<code>DOCKER_PASSWORD</code> secret。</p><p>其中，<code>DOCKER_USERNAME</code>保存腾讯云镜像服务（CCR）的用户名，<code>DOCKER_PASSWORD</code>保存CCR的密码。我们将这两个secret保存在<code>helloci</code> Environments中，如下图所示：</p><p><img src="https://static001.geekbang.org/resource/image/c0/d3/c00b11a1709838c1a205ace7976768d3.png?wh=1920x1046" alt="图片"></p><p><strong>第六步，</strong>将项目push到GitHub，触发workflow工作流：</p><pre><code class="language-bash">$ git add .
$ git push origin master
</code></pre><p>打开我们的仓库 Actions 标签页，可以发现GitHub Actions workflow正在执行：</p><p><img src="https://static001.geekbang.org/resource/image/1a/8a/1afb7860d68635c5e3eaba4ff8da208a.png?wh=1920x691" alt="图片"></p><p>等workflow执行完，点击 <strong>Go Test</strong> 进入构建详情页面，在详情页面能够看到我们的构建历史：</p><p><img src="https://static001.geekbang.org/resource/image/a4/95/a4b83a122379db4f2fe9538afdfb5a95.png?wh=1920x701" alt="图片"></p><p>然后，选择其中一个构建记录，查看其运行详情（具体可参考<a href="https://github.com/marmotedu/helloci/actions/runs/1144156183">chore: update step name Go Test #10</a>）：</p><p><img src="https://static001.geekbang.org/resource/image/48/4f/481f64aabccf30ed61d0a7c85ab30d4f.png?wh=1920x1084" alt="图片"></p><p>你可以看到，<code>Go Test</code>工作流程执行了6个Job，每个Job执行了下面这些自定义Step：</p><ol>
<li>Set up Go 1.16。</li>
<li>Check out code into the Go module directory。</li>
<li>Tidy。</li>
<li>Build。</li>
<li>Collect main.go file。</li>
<li>Publish to Registry。</li>
</ol><p>其他步骤是GitHub Actions自己添加的步骤：<code>Setup Job</code>、<code>Post Check out code into the Go module directory</code>、<code>Complete job</code>。点击每一个步骤，你都能看到它们的详细输出。</p><h2>IAM GitHub Actions实战</h2><p>接下来，我们再来看下IAM项目的GitHub Actions实战。</p><p>假设IAM项目根目录为 <code>${IAM_ROOT}</code>，它的workflow配置文件为：</p><pre><code class="language-bash">$ cat ${IAM_ROOT}/.github/workflows/iamci.yaml
name: IamCI

on:
  push:
    branchs:
    - '*'
  pull_request:
    types: [opened, reopened]

jobs:

  iamci:
    name: Test with go ${{ matrix.go_version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    environment:
      name: iamci

    strategy:
      matrix:
        go_version: [1.16]
        os: [ubuntu-latest]

    steps:

      - name: Set up Go ${{ matrix.go_version }}
        uses: actions/setup-go@v2
        with:
          go-version: ${{ matrix.go_version }}
        id: go

      - name: Check out code into the Go module directory
        uses: actions/checkout@v2

      - name: Run go modules Tidy
        run: |
          make tidy

      - name: Generate all necessary files, such as error code files
        run: |
          make gen

      - name: Check syntax and styling of go sources
        run: |
          make lint

      - name: Run unit test and get test coverage
        run: |
          make cover

      - name: Build source code for host platform
        run: |
          make build

      - name: Collect Test Coverage File
        uses: actions/upload-artifact@v1.0.0
        with:
          name: main-output
          path: _output/coverage.out

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build docker images for host arch and push images to registry
        run: |
          make push
</code></pre><p>上面的workflow依次执行了以下步骤：</p><ol>
<li>设置Go编译环境。</li>
<li>下载IAM项目源码。</li>
<li>添加/删除不需要的Go包。</li>
<li>生成所有的代码文件。</li>
<li>对IAM源码进行静态代码检查。</li>
<li>运行单元测试用例，并计算单元测试覆盖率是否达标。</li>
<li>编译代码。</li>
<li>收集构建产物<code>_output/coverage.out</code>。</li>
<li>配置Docker构建环境。</li>
<li>登陆DockerHub。</li>
<li>构建Docker镜像，并push到DockerHub。</li>
</ol><p>IamCI workflow运行历史如下图所示：</p><p><img src="https://static001.geekbang.org/resource/image/2b/b0/2b542f9101be0c3a83576fb99bf882b0.png?wh=1920x844" alt="图片"></p><p>IamCI workflow的其中一次工作流程运行结果如下图所示：</p><p><img src="https://static001.geekbang.org/resource/image/e9/6a/e9ebf13fdb6e4f41a1b00406e646ec6a.png?wh=1920x887" alt="图片"></p><h2>总结</h2><p>在Go项目开发中，我们需要通过CI任务来将需要频繁操作的任务自动化，这不仅可以提高开发效率，还能减少手动操作带来的失误。这一讲，我选择了最易实践的GitHub Actions，来给你演示如何构建CI任务。</p><p>GitHub Actions支持通过push事件来触发CI流程。一个CI流程其实就是一个workflow，workflow中包含多个任务，这些任务是可以并行执行的。一个任务又包含多个步骤，每一步又由多个动作组成。动作（Action）其实是一个命令/脚本，用来完成我们指定的任务，如编译等。</p><p>因为GitHub Actions内容比较多，这一讲只介绍了一些核心的知识，更详细的GitHub Actions教程，你可以参考 <a href="https://docs.github.com/cn/actions">官方中文文档</a>。</p><h2>课后练习</h2><ol>
<li>使用CODING实现IAM的CI任务，并思考下：GitHub Actions和CODING在CI任务构建上，有没有本质的差异？</li>
<li>这一讲，我们借助GitHub Actions实现了CI，请你结合前面所学的知识，实现IAM的CD功能。欢迎提交Pull Request。</li>
</ol><p>这是我们这门课的最后一次练习题了，欢迎把你的思考和想法分享在留言区，也欢迎把课程分享给你的同事、朋友，我们一起交流，一起进步。</p><h2>精选留言：</h2>
        <ul>
        
<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            pedro  2021-09-28 08:32:39
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            最后一讲留个言，专栏基本覆盖 Go 技术栈的方方面面，还有很多工具的加餐，项目开发规范，云原生，容器等知识，物超所值。<br><br>代码质量很高，学习了很多，一路走来，多谢了～ [6赞]
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;        line-height:1.2">作者回复2021-09-29 00:33:42</div>
    <div style="color:#353535;font-weight:400;white-space:normal;        word-break:break-all;line-height:1.6">感谢老哥能够坚持学习到最后</div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            Realm  2021-09-29 08:04:41
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            很专业、很系统，感谢老师的指引。<br><br>内容覆盖了编程技巧、工程化、云原生实践的经验总结，当然还有加餐鸡腿.<br><br>收获很大，谢谢老师！ [1赞]
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            随风而过  2021-09-30 10:25:01
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            整个专栏质量很高，文案虽然有些瑕疵，不影响整体专栏的专业度，专栏介绍了很多编程规范，主要还是云原生范畴内，看完整个专栏有很多反思，对go语言自我的认知有一个全新的提高(比如项目目录参杂其他语言的习惯目录结构来做是错误的，还有代码规范也会参照其他语言来组织)。<br>也到说再见的时候了，希望老师在出高质量的专栏，订阅破万，与君共勉。。。。 
        </div>
        
    </div>
</li>
            </ul>
</div>
</body>
</html>