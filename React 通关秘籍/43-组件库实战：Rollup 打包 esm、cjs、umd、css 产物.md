前面我们分别实现了组件库的 commonjs、es module、umd 代码的构建，以及 css 的构建。

但是还是有一些问题的：

commonjs 和 es module 代码是直接用 tsc 编译的。

这要求组件代码里不能引入 css 模块，不然运行时会报错。

我们是用 sass 单独编译了 css 文件，然后运行时单独引入组件对应的 css。

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/264aa89930404a3eb6214642ec86ec3c~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.jpg#?w=1070&h=1122&s=166217&e=png&b=f8f8f8)

这些组件的 css 并没有打包到一块。

而 umd 代码需要再单独用 webpack 打包一次。

也就是这两个问题：

* 如何自动抽离组件里引入的 css 代码并打包到一个文件？

* 能不能 commonjs、es module 还有 umd 用同一个构建配置，而不是分别用 tsc、webpack 构建？

很明显，这就需要用 rollup 来打包了。

我们来试一下：

创建项目：

```bash
mkdir guang-components-rollup
cd guang-components-rollup
npm init -y
```

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6a23b73b96cf46af9e772c00cfd449fb~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.jpg#?w=976&h=672&s=146772&e=png&b=010101)

进入项目，把之前的 Calendar、Message、Watermark 组件复制过来。

（从原来的组件那里复制，不要从之前的组件库项目里复制，那些是改动后的）

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fd161658b554496ca25bf698d0cf251d~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.jpg#?w=808&h=808&s=98486&e=png&b=191919)

创建 src/index.ts 把组件和类型导出：

```javascript
import Calendar, { CalendarProps } from './Calendar';
import Watermark, { WatermarkProps } from './Watermark';
import { MessageProps, Position, MessageRef} from './Message';
import { useMessage } from './Message/useMessage';
import { ConfigProvider } from './Message/ConfigProvider';

export {
    Calendar,
    Watermark,
    ConfigProvider,
    useMessage
}

export type {
    CalendarProps,
    WatermarkProps,
    MessageProps,
    Position,
    MessageRef
}
```

安装下用到的包：

```kotlin
npm install --save react@18 react-dom@18

npm install --save dayjs ahooks classnames react-transition-group lodash-es

npm install --save-dev @types/lodash-es @types/react-dom @types/react-transition-group
```

然后安装 rollup 来做打包：

```css
npm install --save-dev rollup
```

创建 rollup 配置文件：

rollup.config.mjs

```javascript
import postcss from 'rollup-plugin-postcss';
import typescript from '@rollup/plugin-typescript';
import resolve from '@rollup/plugin-node-resolve';
import commonjs from '@rollup/plugin-commonjs';
import replace from '@rollup/plugin-replace';

/** @type {import("rollup").RollupOptions} */
export default {
    input: 'src/index.ts',
    external: [ 'react', 'react-dom' ],
    output: [
        {
            file: 'dist/esm.js',
            format: 'esm'
        },
        {
            file: 'dist/cjs.js',
            format: "cjs"
        },
        {
            file: 'dist/umd.js',
            name: 'Guang',
            format: "umd"
        }
    ],
    plugins: [
        resolve(),
        commonjs(),
        typescript({
            tsconfig: 'tsconfig.json'
        }),
        postcss({
            extract: true,
            extract: 'index.css'
        }),
        replace({
            'process.env.NODE_ENV': '"production"'
        })
    ]
};
```

input 指定入口模块。

output 指定产物的格式，分别打包 esm、cjs、umd 模块规范的产物。

external 是指定不打包到产物里的 npm 包。

plugins 里的 typescript 插件是做 ts 代码编译的，postcss 插件是做 css 代码的编译和合并的。

[node-resolve 插件](https://www.npmjs.com/package/@rollup/plugin-node-resolve "https://www.npmjs.com/package/@rollup/plugin-node-resolve")是解析 node\_modules 下的包的：

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7a547a97a85a4f8eb9bd86c483d64bd6~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.jpg#?w=1240&h=260&s=49456&e=png&b=fefefe)

而 [commonjs 插件](https://www.npmjs.com/package/@rollup/plugin-commonjs "https://www.npmjs.com/package/@rollup/plugin-commonjs")是转换 commonjs 到 es module 的（因为 rollup 只支持 es module 模块）:

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/44776e9204544af48704ef19cbbf1341~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.jpg#?w=1206&h=286&s=40539&e=png&b=fefefe)

这俩插件基本都是必用的。

创建 tsconfig.json

```javascript
{
    "compilerOptions": {
      "outDir": "dist",
      "declaration": true,
      "allowSyntheticDefaultImports": true,
      "target": "es2015",
      "lib": ["ES2020", "DOM", "DOM.Iterable"],
      "module": "ESNext",
      "skipLibCheck": true,
      "moduleResolution": "bundler",
      "allowImportingTsExtensions": true,
      "resolveJsonModule": true,
      "isolatedModules": true,
      "noEmit": true,      
      "jsx": "react-jsx", 
      "strict": true,
    },
    "include": [
      "src"
    ],
    "exclude": [
      "src/**/*.test.tsx",
      "src/**/*.stories.tsx"
    ]
 }
```

这里 jsx 指定为 react，也就是会把 <div> 转换成 React.createElement("div")

安装下这些依赖（还要安装下 sass）：

```scss
npm install --save-dev sass @rollup/plugin-commonjs @rollup/plugin-node-resolve @rollup/plugin-replace @rollup/plugin-typescript rollup-plugin-postcss
```

然后打包下：

```arduino
npx rollup -c rollup.config.mjs
```

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6abf256e7f564745b8dda94af1575897~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.jpg#?w=1260&h=756&s=169589&e=png&b=181818)

看下产物：

umd： ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a2c243078caf49b9843d27f614c60557~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.jpg#?w=2084&h=584&s=218985&e=png&b=1e1e1e)

esm： ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2fada60f98774069a01d4d9e0025a1b5~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.jpg#?w=1768&h=614&s=194320&e=png&b=1d1d1d)

cjs：

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0c45b5e1d00546ec942d75dfe20f6867~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.jpg#?w=1462&h=688&s=206085&e=png&b=1d1d1d)

css：

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3807a4dbfa654757a51843b975d0701c~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.jpg#?w=1386&h=734&s=190360&e=png&b=1d1d1d)

dts：

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0e4918d88878486687270d8734fbd8a2~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.jpg#?w=1446&h=800&s=228884&e=png&b=1d1d1d)

都没问题。

rollup 抽离出 css 代码后打包到了一个文件里，这样只要引入这个 index.css 就好了。

而且 rollup 支持 tree shaking，会去掉 js 产物里的引入的 css 模块。

所以源码里引入的 scss 就不用去掉了：

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/262824b81270470ba90db2625d3a5c19~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.jpg#?w=1372&h=554&s=176269&e=png&b=1d1d1d)

我们添加下 README.md

    # React 组件库 guang-components-rollup

    [《React 通关秘籍》](https://juejin.cn/book/7294082310658326565) 小册组件库案例

    ## Install
    \```
    npm install --save guang-components-rollup@latest
    \```

    ## Usage

    ### Watermark 组件
    \```javascript
    import { Watermark } from 'guang-components-rollup';

    const App = () => {
      return <Watermark
        content={['测试水印', '神说要有光']}
      >
       <div style={{height: 800}}>
        <p>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quos quod deserunt quidem quas in rem ipsam ut nesciunt asperiores dignissimos recusandae minus, eaque, harum exercitationem esse sapiente? Eveniet, id provident!</p>
        <p>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quos quod deserunt quidem quas in rem ipsam ut nesciunt asperiores dignissimos recusandae minus, eaque, harum exercitationem esse sapiente? Eveniet, id provident!</p>
        <p>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quos quod deserunt quidem quas in rem ipsam ut nesciunt asperiores dignissimos recusandae minus, eaque, harum exercitationem esse sapiente? Eveniet, id provident!</p>
        <p>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quos quod deserunt quidem quas in rem ipsam ut nesciunt asperiores dignissimos recusandae minus, eaque, harum exercitationem esse sapiente? Eveniet, id provident!</p>
        <p>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quos quod deserunt quidem quas in rem ipsam ut nesciunt asperiores dignissimos recusandae minus, eaque, harum exercitationem esse sapiente? Eveniet, id provident!</p>
        <p>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quos quod deserunt quidem quas in rem ipsam ut nesciunt asperiores dignissimos recusandae minus, eaque, harum exercitationem esse sapiente? Eveniet, id provident!</p>
        <p>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quos quod deserunt quidem quas in rem ipsam ut nesciunt asperiores dignissimos recusandae minus, eaque, harum exercitationem esse sapiente? Eveniet, id provident!</p>
       </div>
      </Watermark>
    };

    export default App;
    \```

    ### Calendar 

    \```javascript
    import dayjs from 'dayjs';
    import {Calendar} from 'guang-components-rollup';
    import 'guang-components-rollup/dist/index.css';

    function App() {
      return (
        <div>
          <Calendar defaultValue={dayjs('2024-07-01')}></Calendar>
        </div>
      );
    }

    export default App;
    \```

    ### Message

    \```javascript
    import { ConfigProvider, useMessage } from "guang-components-rollup"
    import 'guang-components-rollup/dist/index.css';

    function Aaa() {
      const message = useMessage();

      return <button onClick={() =>{
        message.add({
          content:'请求成功'
        })
      }}>成功</button>
    }

    function App() {

      return (
        <ConfigProvider>
          <div>
            <Aaa></Aaa>
          </div>
        </ConfigProvider>
      );
    }

    export default App;
    \```

然后改下 package.json

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9499303cd160468091c0ef139afe2f3a~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.jpg#?w=1058&h=760&s=114122&e=png&b=1f1f1f)

```javascript
"main": "dist/cjs.js",
"module": "dist/esm.js",
"types": "dist/index.d.ts",
"unpkg": "/dist/umd.js",
"files": [
    "dist",
    "package.json",
    "README.md"
],
```

发个 npm 包：

```
npm adduser

npm publish
```

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7c2eb049c5464a5c885874ac5db111ea~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.jpg#?w=1420&h=264&s=54425&e=png&b=181818)

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5c6551843d5c42388a4b59dcbcbc4a4b~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.jpg#?w=1514&h=1334&s=365741&e=png&b=181818)

发布成功。

去 [npm 网站](https://www.npmjs.com/package/guang-components-rollup "https://www.npmjs.com/package/guang-components-rollup")搜一下：

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fc6ad8161fee41bf8615b653c6fdad62~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.jpg#?w=1760&h=1512&s=261744&e=png&b=fcfcfc)

然后我们创建个项目引入下试试：

```lua
npx create-vite my-comp-lib-test
```

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9bf1ca238da8495e96152a7aab9f95e5~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.jpg#?w=936&h=386&s=48696&e=png&b=010101)

进入项目，安装我们的组件库：

```css
npm install

npm install --save guang-components-rollup@latest
```

去掉 main.tsx 里的样式：

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0c96ed026ee04bd8accde076dfba2db7~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.jpg#?w=984&h=398&s=75463&e=png&b=1f1f1f)

然后改下 App.tsx

```javascript
import { ConfigProvider, useMessage } from "guang-components-rollup"
import 'guang-components-rollup/dist/index.css';

function Aaa() {
  const message = useMessage();

  return <button onClick={() =>{
    message.add({
      content:'请求成功'
    })
  }}>成功</button>
}

function App() {

  return (
    <ConfigProvider>
      <div>
        <Aaa></Aaa>
      </div>
    </ConfigProvider>
  );
}

export default App;
```

跑一下:

```arduino
npm run dev
```

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f72e9d6e81764307b8ed100b83517103~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.jpg#?w=838&h=304&s=38179&e=png&b=191919)

![2024-12-07 13.13.10.gif](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0fe781a7219245f2abe7faabc674dc97~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.gif#?w=2002&h=902&s=376584&e=gif&f=43&b=fefefe)

样式、逻辑都没问题。

再试下 Calendar：

```javascript
import dayjs from 'dayjs';
import {Calendar} from 'guang-components-rollup';
import 'guang-components-rollup/dist/index.css';

function App() {
  return (
    <div>
      <Calendar defaultValue={dayjs('2024-07-01')}></Calendar>
    </div>
  );
}

export default App;
```

安装用到的 dayjs：

```css
npm install --save dayjs
```

浏览器看下：

![2024-12-07 13.18.19.gif](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/04bafcb6110e4e7f88daffd92b45cee2~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.gif#?w=2704&h=1364&s=263555&e=gif&f=52&b=fdfdfd)

样式、逻辑都没问题。

最后试下 Watermark 组件：

```javascript
import { Watermark } from 'guang-components-rollup';

const App = () => {
  return <Watermark
    content={['测试水印', '神说要有光']}
  >
   <div style={{height: 800}}>
    <p>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quos quod deserunt quidem quas in rem ipsam ut nesciunt asperiores dignissimos recusandae minus, eaque, harum exercitationem esse sapiente? Eveniet, id provident!</p>
    <p>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quos quod deserunt quidem quas in rem ipsam ut nesciunt asperiores dignissimos recusandae minus, eaque, harum exercitationem esse sapiente? Eveniet, id provident!</p>
    <p>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quos quod deserunt quidem quas in rem ipsam ut nesciunt asperiores dignissimos recusandae minus, eaque, harum exercitationem esse sapiente? Eveniet, id provident!</p>
    <p>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quos quod deserunt quidem quas in rem ipsam ut nesciunt asperiores dignissimos recusandae minus, eaque, harum exercitationem esse sapiente? Eveniet, id provident!</p>
    <p>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quos quod deserunt quidem quas in rem ipsam ut nesciunt asperiores dignissimos recusandae minus, eaque, harum exercitationem esse sapiente? Eveniet, id provident!</p>
    <p>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quos quod deserunt quidem quas in rem ipsam ut nesciunt asperiores dignissimos recusandae minus, eaque, harum exercitationem esse sapiente? Eveniet, id provident!</p>
    <p>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quos quod deserunt quidem quas in rem ipsam ut nesciunt asperiores dignissimos recusandae minus, eaque, harum exercitationem esse sapiente? Eveniet, id provident!</p>
   </div>
  </Watermark>
};

export default App;
```

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/30ba9a7641954feeba8e50b70f33d7f7~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.jpg#?w=2402&h=1272&s=344289&e=png&b=fefefe)

也没问题。

然后再来试下 umd 产物：

创建 test.html

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://unpkg.com/react@18.3.1/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18.3.1/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/dayjs@1.11.11/dayjs.min.js"></script>
    <script src="https://unpkg.com/guang-components-rollup@1.1.1/dist/umd.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/guang-components-rollup@1.1.1/dist/index.css" />

</head>
<body>
    <div id="root"></div>
    <script>
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);

        root.render(React.createElement(Guang.Calendar, { defaultValue: dayjs('2024-07-01') }));
    </script>
</body>
</html>
```

跑个静态服务器：

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a5c1459f49b7454da2a02b40f157f1e9~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.jpg#?w=776&h=560&s=87089&e=png&b=181818)

浏览器访问下 [http://localhost:8080/test.html](http://localhost:8080/test.html "http://localhost:8080/test.html")

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0ebec7899d0e48bba10ca3948f55897b~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.jpg#?w=2668&h=1260&s=133367&e=png&b=fefefe)

umd 产物也没问题。

这样，我们通过 rollup 打包 cjs、esm、umd 产物就都成功了。

案例代码上传了[小册仓库](https://github.com/QuarkGluonPlasma/react-course-code/tree/main/guang-components-rollup "https://github.com/QuarkGluonPlasma/react-course-code/tree/main/guang-components-rollup")。

## 总结

这节我们通过 rollup 做了组件库的打包。

分别支持了 esm、cjs、umd 还有 css 的打包。

相比之前用 tsc 编译 esm、cjs，用 webpack 打包 umd，然后用 sass 编译 css 文件。

用 tsc、webpack 是可以的，我们分析过，很多主流组件库都这么搞。

但用 rollup 来做简单的多，可以一次性打包出这些产物。

所以一般自己写组件库，都是用 rollup 来打包的。